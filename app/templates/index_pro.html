<!doctype html>
<html lang="fr" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>MCPanel Pro - Gestionnaire de Serveurs</title>
    <link rel="stylesheet" href="/static/style_clean.css" />
    <link rel="stylesheet" href="/static/libs/fontawesome/css/all.min.css" />
    <script src="/static/libs/chart.min.js"></script>
  </head>

  <body>
    <aside class="sidebar">
      <div class="logo">
        <i class="fas fa-cubes"></i>
        <h1>MCPanel</h1>
      </div>

      <!-- Language Selector -->
      <div class="language-selector">
        <button
          class="lang-btn"
          id="current-lang"
          onclick="toggleLanguageDropdown()"
        >
          üá´üá∑ FR
        </button>
        <div class="lang-dropdown" id="lang-dropdown">
          <button class="lang-option" onclick="changeLanguage('fr')">
            üá´üá∑ Fran√ßais
          </button>
          <button class="lang-option" onclick="changeLanguage('en')">
            üá¨üáß English
          </button>
          <button class="lang-option" onclick="changeLanguage('es')">
            üá™üá∏ Espa√±ol
          </button>
        </div>
      </div>

      <div class="user-info" id="user-info">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-details">
          <span class="user-name" id="user-name">Admin</span>
          <span class="user-role" id="user-role" data-i18n="auth.admin"
            >Administrateur</span
          >
        </div>
        <div class="user-menu">
          <button
            onclick="openSettings()"
            data-i18n-title="nav.settings"
            title="Param√®tres"
          >
            <i class="fas fa-cog"></i>
          </button>
          <button
            onclick="logout()"
            data-i18n-title="auth.logout"
            title="D√©connexion"
          >
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="nav-menu">
        <button
          class="nav-item active"
          data-section="dashboard"
          onclick="showSection('dashboard')"
        >
          <i class="fas fa-th-large"></i>
          <span data-i18n="nav.dashboard">Tableau de bord</span>
        </button>
        <button
          class="nav-item"
          data-section="servers"
          onclick="showSection('servers')"
        >
          <i class="fas fa-server"></i>
          <span data-i18n="nav.servers">Serveurs</span>
        </button>
        <button
          class="nav-item"
          data-section="notifications"
          onclick="showSection('notifications')"
        >
          <i class="fas fa-bell"></i>
          <span data-i18n="nav.notifications">Notifications</span>
          <span class="badge" id="notif-badge" style="display: none">0</span>
        </button>
        <button
          class="nav-item admin-only"
          data-section="swarm"
          onclick="showSection('swarm')"
        >
          <i class="fas fa-network-wired"></i>
          <span>Swarm Infra</span>
        </button>
        <button
          class="nav-item"
          data-section="docker-dashboard"
          onclick="showSection('docker-dashboard')"
        >
          <i class="fab fa-docker"></i>
          <span>Docker</span>
        </button>
        <button
          class="nav-item"
          data-section="marketplace"
          onclick="showSection('marketplace')"
        >
          <i class="fas fa-shopping-bag"></i>
          <span data-i18n="nav.marketplace">Marketplace</span>
        </button>
        <a
          href="/admin/governance"
          class="nav-item admin-only"
          id="admin-gov-link"
          style="display: none"
        >
          <i class="fas fa-gavel"></i>
          <span>Gouvernance</span>
        </a>
        <button
          class="nav-item"
          data-section="settings"
          onclick="showSection('settings')"
        >
          <i class="fas fa-sliders-h"></i>
          <span data-i18n="nav.settings">Param√®tres</span>
        </button>
      </nav>

      <div class="sidebar-divider"></div>

      <!-- Server List -->
      <div class="sidebar-label">Serveurs</div>
      <div class="server-list" id="server-list"></div>

      <button class="btn-create-large" onclick="openModal()">
        <i class="fas fa-plus-circle"></i>
        <span data-i18n="server.create">Nouveau Serveur</span>
      </button>

      <!-- System Stats Mini -->
      <div class="system-mini">
        <div class="mini-stat">
          <i class="fas fa-microchip"></i>
          <span id="mini-cpu">0%</span>
        </div>
        <div class="mini-stat">
          <i class="fas fa-memory"></i>
          <span id="mini-ram">0%</span>
        </div>
        <div class="mini-stat">
          <i class="fas fa-hdd"></i>
          <span id="mini-disk">0%</span>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- SECTION: DASHBOARD -->
      <section id="section-marketplace" class="section">
        <!-- MARKETPLACE CONTENT -->
        <div class="row">
          <div class="col-md-12">
            <h1 class="mb-4">Marketplace (Modrinth)</h1>

            <div class="card mb-4">
              <div class="card-body">
                <div class="input-group">
                  <input
                    type="text"
                    id="marketSearch"
                    class="form-control"
                    placeholder="Rechercher des plugins/mods..."
                    onkeypress="handleEnter(event)"
                  />
                  <div class="input-group-append">
                    <button class="btn btn-primary" onclick="searchMarket()">
                      Rechercher
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="marketLoading" class="text-center d-none">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Chargement...</span>
              </div>
              <p>Recherche en cours...</p>
            </div>

            <div id="marketResults" class="row"></div>

            <!-- modal for mod details -->
            <div class="modal fade" id="modDetailsModal" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="modDetailsTitle"></h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body" id="modDetailsBody">
                    <div class="loader-small"></div>
                    Chargement...
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-dismiss="modal"
                    >
                      Fermer
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Modals for marketplace -->
        <div class="modal fade" id="installModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  Installer <span id="installTitle"></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="serverSelect"
                    >S√©lectionner le serveur de destination :</label
                  >
                  <select class="form-control" id="serverSelect">
                    <option value="">Chargement...</option>
                  </select>
                </div>
                <div id="installStatus" class="alert d-none"></div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-dismiss="modal"
                >
                  Annuler
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="confirmInstallBtn"
                >
                  Confirmer l'installation
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section id="section-docker-dashboard" class="section">
        <!-- Docker dashboard inline content -->
        <div class="container-fluid">
          <h1 class="mt-4">üê≥ Gestion Docker</h1>

          <div
            class="alert alert-warning"
            id="docker-warning"
            style="display: none"
          >
            Docker n'est pas d√©tect√© sur le syst√®me.
            <button class="btn btn-primary btn-sm" onclick="installDocker()">
              Installer Docker
            </button>
          </div>

          <div id="docker-content" style="display: none">
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card text-white bg-primary mb-3">
                  <div class="card-header">Conteneurs MC</div>
                  <div class="card-body">
                    <h5 class="card-title display-4" id="docker-count">0</h5>
                  </div>
                </div>
              </div>
              <div class="col-md-9">
                <div class="card">
                  <div class="card-header">Actions Globales</div>
                  <div class="card-body">
                    <button
                      class="btn btn-outline-danger"
                      onclick="pruneDocker()"
                    >
                      Nettoyer Images Inutilis√©es (Prune)
                    </button>
                    <button class="btn btn-outline-info" onclick="loadDocker()">
                      Rafra√Æchir
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">Conteneurs Minecraft</div>
              <div class="card-body table-responsive">
                <table class="table table-hover" id="docker-table">
                  <thead>
                    <tr>
                      <th>Serveur</th>
                      <th>Status</th>
                      <th>Image</th>
                      <th>√âtat</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section id="section-swarm" class="section">
        <div class="container-fluid">
          <h1>Dashboard Infrastructure (Swarm)</h1>

          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <h2>
                    <i class="fas fa-server"></i> Gestion des Machines (Noeuds)
                  </h2>
                  <button
                    class="btn btn-primary admin-only"
                    onclick="showAddNodeModal()"
                  >
                    <i class="fas fa-plus"></i> Ajouter une machine
                  </button>
                </div>
                <table
                  class="table"
                  style="
                    width: 100%;
                    margin-top: 15px;
                    color: var(--text-color);
                  "
                >
                  <thead>
                    <tr>
                      <th>Hostname</th>
                      <th>R√¥le</th>
                      <th>Statut</th>
                      <th>CPU/RAM (Estim√©)</th>
                      <th class="admin-only">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="swarm-node-table">
                    <!-- nodes inserted by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <h2>√âtat du Cluster</h2>
                <p>Status: <span id="swarm-status-text">...</span></p>
                <h3>Noeuds</h3>
                <ul id="swarm-nodes-list"></ul>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card admin-only">
                <h2>Configuration</h2>
                <form id="swarmConfigForm">
                  <!-- example fields, could be expanded -->
                  <div class="form-group">
                    <label for="swarmMode">Mode</label>
                    <select
                      id="swarmMode"
                      class="form-control"
                      onchange="toggleSwarmFields()"
                    >
                      <option value="local">Local</option>
                      <option value="remote">Remote (SSH)</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="swarmSSHHost">SSH Host</label>
                    <input type="text" id="swarmSSHHost" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label for="swarmSSHUser">SSH User</label>
                    <input type="text" id="swarmSSHUser" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label for="swarmSSHKey">SSH Key Path</label>
                    <input type="text" id="swarmSSHKey" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label for="swarmRegistry">Registry Domain</label>
                    <input
                      type="text"
                      id="swarmRegistry"
                      class="form-control"
                    />
                  </div>
                  <div class="form-group">
                    <label for="swarmNfsIp">NFS Server IP</label>
                    <input type="text" id="swarmNfsIp" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label for="swarmNfsPath">NFS Path</label>
                    <input type="text" id="swarmNfsPath" class="form-control" />
                  </div>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="saveSwarmConfig()"
                  >
                    Enregistrer
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section id="section-dashboard" class="section active">
        <div class="section-header">
          <h2><i class="fas fa-th-large"></i> Tableau de bord</h2>
          <div class="header-actions">
            <button class="btn-icon" onclick="refreshAll()" title="Actualiser">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>

        <!-- System Metrics Cards -->
        <div class="metrics-grid">
          <div class="metric-card cpu">
            <div class="metric-icon"><i class="fas fa-microchip"></i></div>
            <div class="metric-content">
              <span class="metric-label">CPU</span>
              <span class="metric-value" id="dash-cpu">0%</span>
            </div>
            <div class="metric-chart">
              <canvas id="chart-cpu" width="100" height="40"></canvas>
            </div>
          </div>
          <div class="metric-card ram">
            <div class="metric-icon"><i class="fas fa-memory"></i></div>
            <div class="metric-content">
              <span class="metric-label">RAM</span>
              <span class="metric-value" id="dash-ram">0 / 0 GB</span>
            </div>
            <div class="metric-chart">
              <canvas id="chart-ram" width="100" height="40"></canvas>
            </div>
          </div>
          <div class="metric-card disk">
            <div class="metric-icon"><i class="fas fa-hdd"></i></div>
            <div class="metric-content">
              <span class="metric-label">Disque</span>
              <span class="metric-value" id="dash-disk">0 / 0 GB</span>
            </div>
            <div class="metric-progress">
              <div
                class="progress-bar"
                id="disk-progress"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div class="metric-card servers">
            <div class="metric-icon"><i class="fas fa-server"></i></div>
            <div class="metric-content">
              <span class="metric-label">Serveurs</span>
              <span class="metric-value"
                ><span id="dash-servers-online">0</span> /
                <span id="dash-servers-total">0</span></span
              >
            </div>
          </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
          <div class="dashboard-card servers-overview">
            <div class="card-header">
              <h3><i class="fas fa-server"></i> Serveurs</h3>
              <button class="btn-sm" onclick="openModal()">
                <i class="fas fa-plus"></i> Nouveau
              </button>
            </div>
            <div class="servers-table" id="servers-table"></div>
          </div>

          <div class="dashboard-card recent-activity">
            <div class="card-header">
              <h3><i class="fas fa-clock"></i> Activit√© r√©cente</h3>
            </div>
            <div class="activity-list" id="activity-list"></div>
          </div>
        </div>

        <!-- Main Chart -->
        <div class="charts-grid">
          <div class="chart-card">
            <div class="card-header">
              <h3><i class="fas fa-chart-area"></i> Performance syst√®me</h3>
              <select
                id="chart-period"
                onchange="updateChartPeriod(this.value)"
              >
                <option value="60">1 minute</option>
                <option value="300" selected>5 minutes</option>
              </select>
            </div>
            <canvas id="main-chart" height="200"></canvas>
          </div>
        </div>
      </section>

      <!-- SECTION: SERVERS -->
      <section id="section-servers" class="section">
        <div id="servers-list-view">
          <div class="section-header">
            <h2><i class="fas fa-server"></i> Serveurs</h2>
            <button class="btn-primary" onclick="openModal()">
              <i class="fas fa-plus"></i> Nouveau serveur
            </button>
          </div>
          <div class="servers-grid" id="servers-grid"></div>
        </div>

        <div id="server-detail-view" style="display: none">
          <div class="server-header">
            <button class="btn-back" onclick="showServersList()">
              <i class="fas fa-arrow-left"></i>
              <span data-i18n="actions.back">Retour</span>
            </button>
            <div class="server-info">
              <button
                id="server-detail-icon"
                type="button"
                onclick="initiateIconUpload()"
                title="Changer l'ic√¥ne"
                aria-label="Changer l'ic√¥ne"
                class="server-detail-icon"
                style="
                  cursor: pointer;
                  width: 64px;
                  height: 64px;
                  margin-right: 15px;
                  border-radius: 8px;
                  overflow: hidden;
                  background: #333;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <img
                  src=""
                  alt="Icon"
                  style="width: 100%; height: 100%; object-fit: cover"
                  onerror="
                    this.onerror = null;
                    this.src = '/static/img/default_icon.svg';
                  "
                />
              </button>
              <div>
                <h2 id="detail-server-name">Serveur</h2>
                <div
                  style="
                    display: flex;
                    gap: 8px;
                    align-items: center;
                    margin-top: 6px;
                  "
                >
                  <div
                    id="server-version-badge"
                    class="status-badge"
                    style="
                      padding: 4px 8px;
                      font-size: 0.85em;
                      background: rgba(255, 255, 255, 0.04);
                    "
                  >
                    <span id="server-version-text">‚Äî</span>
                  </div>
                </div>
                <!-- Debug: affichage rapide de la config renvoy√©e par l'API (visible temporairement) -->
                <div
                  id="server-config-debug"
                  style="
                    display: none;
                    margin-top: 8px;
                    background: rgba(0, 0, 0, 0.04);
                    padding: 8px;
                    border-radius: 6px;
                    font-size: 0.82em;
                    max-height: 180px;
                    overflow: auto;
                    color: #e6eef8;
                  "
                >
                  <!-- header and actions will be filled dynamically -->
                  <div
                    style="
                      display: flex;
                      gap: 8px;
                      align-items: center;
                      margin-bottom: 6px;
                    "
                  ></div>
                  <pre
                    class="server-config-json"
                    style="
                      margin: 0;
                      white-space: pre-wrap;
                      word-break: break-word;
                      background: transparent;
                      border: none;
                      color: #cbd5e1;
                      padding-top: 6px;
                    "
                  ></pre>
                </div>
                <div class="status-badge offline" id="detail-status">
                  <span class="status-dot"></span>
                  <span id="detail-status-text">OFFLINE</span>
                </div>
                <div
                  class="server-address-display"
                  id="server-address-display"
                  style="display: none"
                >
                  <i class="fas fa-link"></i>
                  <span id="server-address-text">-</span>
                  <button
                    class="copy-btn-small"
                    onclick="copyCurrentServerAddress()"
                    data-i18n-title="actions.copy"
                    title="Copier l'adresse"
                  >
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="server-actions">
              <button
                class="action-btn start"
                id="btn-start"
                onclick="serverAction('start')"
                data-i18n-title="actions.start"
                title="D√©marrer"
              >
                <i class="fas fa-play"></i>
                <span class="action-label" data-i18n="actions.start"
                  >D√©marrer</span
                >
              </button>
              <button
                class="action-btn"
                id="btn-restart"
                onclick="serverAction('restart')"
                data-i18n-title="actions.restart"
                title="Red√©marrer"
              >
                <i class="fas fa-rotate-right"></i>
                <span class="action-label" data-i18n="actions.restart"
                  >Red√©marrer</span
                >
              </button>
              <button
                class="action-btn stop"
                id="btn-stop"
                onclick="serverAction('stop')"
                data-i18n-title="actions.stop"
                title="Arr√™ter"
              >
                <i class="fas fa-stop"></i>
                <span class="action-label" data-i18n="actions.stop"
                  >Arr√™ter</span
                >
              </button>
              <button
                class="action-btn backup"
                onclick="backupServer()"
                data-i18n-title="actions.backup"
                title="Sauvegarder"
              >
                <i class="fas fa-download"></i>
                <span class="action-label" data-i18n="actions.backup"
                  >Backup</span
                >
              </button>
              <button
                class="action-btn tunnel"
                id="btn-tunnel"
                onclick="openTunnelModal()"
                data-i18n-title="actions.share"
                title="Partager le serveur (Tunnel)"
              >
                <i class="fas fa-globe"></i>
                <span class="action-label" data-i18n="actions.share"
                  >Partager</span
                >
              </button>
              <button
                class="action-btn settings owner-only"
                onclick="openServerSettings()"
                data-i18n-title="actions.config"
                title="Param√®tres serveur"
              >
                <i class="fas fa-cog"></i>
                <span class="action-label" data-i18n="actions.config"
                  >Config</span
                >
              </button>
              <button
                class="action-btn owner-only"
                id="btn-update-server"
                onclick="manualUpdateServerConfig()"
                title="Mettre √† jour la config"
              >
                <i class="fas fa-sync-alt"></i>
                <span class="action-label">Mettre √† jour</span>
              </button>
              <button
                class="action-btn danger owner-only"
                onclick="deleteServer()"
                data-i18n-title="actions.delete"
                title="Supprimer"
              >
                <i class="fas fa-trash"></i>
                <span class="action-label" data-i18n="actions.delete"
                  >Supprimer</span
                >
              </button>
            </div>
          </div>

          <!-- Tunnel Status Bar -->
          <div
            id="tunnel-status-bar"
            class="tunnel-address-box"
            style="display: none"
          >
            <div class="tunnel-info">
              <i class="fas fa-globe tunnel-icon"></i>
              <span class="tunnel-label" data-i18n="tunnel.active"
                >Tunnel actif:</span
              >
              <span class="tunnel-address" id="tunnel-address-display">-</span>
              <button
                class="btn-copy-small"
                onclick="copyTunnelAddress()"
                data-i18n-title="tunnel.copy_address"
                title="Copier l'adresse"
              >
                <i class="fas fa-copy"></i>
              </button>
              <button class="tunnel-provider" onclick="stopTunnel()">
                <i class="fas fa-times"></i>
                <span data-i18n="tunnel.stop">Arr√™ter</span>
              </button>
            </div>
          </div>

          <div class="tabs">
            <button
              class="tab active"
              data-view="console"
              onclick="switchTab('console')"
            >
              <i class="fas fa-terminal"></i>
              <span data-i18n="nav.console">Console</span>
            </button>
            <button
              class="tab"
              data-view="players"
              onclick="switchTab('players')"
            >
              <i class="fas fa-users"></i>
              <span data-i18n="nav.players">Joueurs</span>
            </button>
            <button
              class="tab"
              data-view="plugins"
              onclick="switchTab('plugins')"
            >
              <i class="fas fa-puzzle-piece"></i>
              <span data-i18n="nav.plugins">Plugins</span>
            </button>
            <button
              class="tab"
              data-view="config"
              onclick="switchTab('config')"
            >
              <i class="fas fa-cog"></i>
              <span data-i18n="server.config">Configuration</span>
            </button>
            <button class="tab" data-view="mods" onclick="switchTab('mods')">
              <i class="fas fa-cubes"></i> Mods
            </button>
            <button
              class="tab"
              data-view="backups"
              onclick="switchTab('backups')"
            >
              <i class="fas fa-archive"></i>
              <span data-i18n="nav.backups">Sauvegardes</span>
            </button>
            <button class="tab" data-view="stats" onclick="switchTab('stats')">
              <i class="fas fa-chart-bar"></i>
              <span data-i18n="nav.statistics">Statistiques</span>
            </button>
            <button class="tab" data-view="files" onclick="switchTab('files')">
              <i class="fas fa-folder-open"></i>
              <span data-i18n="nav.files">Fichiers</span>
            </button>
          </div>

          <div class="tab-content">
            <!-- Console -->
            <div id="view-console" class="view active">
              <div
                id="console-title"
                style="font-size: 1.2em; margin-bottom: 8px; font-weight: bold"
              ></div>
              <div class="console-stats">
                <div class="stat-mini">
                  <i class="fas fa-microchip"></i> <span id="stat-cpu">0%</span>
                </div>
                <div class="stat-mini">
                  <i class="fas fa-memory"></i> <span id="stat-ram">0 MB</span>
                </div>
                <div class="stat-mini">
                  <i class="fas fa-users"></i> <span id="stat-players">0</span>
                </div>
                <div class="stat-mini">
                  <i class="fas fa-tachometer-alt"></i>
                  <span id="stat-tps">20.0</span> TPS
                </div>
              </div>

              <div class="console-toolbar">
                <div class="console-filters">
                  <button
                    class="filter-btn active"
                    data-filter="all"
                    onclick="filterLogs('all')"
                    data-i18n="common.all"
                  >
                    Tout
                  </button>
                  <button
                    class="filter-btn"
                    data-filter="info"
                    onclick="filterLogs('info')"
                  >
                    Info
                  </button>
                  <button
                    class="filter-btn"
                    data-filter="warn"
                    onclick="filterLogs('warn')"
                  >
                    Warn
                  </button>
                  <button
                    class="filter-btn"
                    data-filter="error"
                    onclick="filterLogs('error')"
                  >
                    Error
                  </button>
                </div>
                <div class="console-actions">
                  <input
                    type="text"
                    id="log-search"
                    data-i18n-placeholder="actions.search"
                    placeholder="Rechercher..."
                    class="search-input"
                    oninput="searchLogs()"
                  />
                  <button
                    class="btn-icon"
                    onclick="exportLogs()"
                    data-i18n-title="actions.download"
                    title="Exporter"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>

              <!-- Commandes favorites -->
              <div class="favorite-commands-bar" id="favorite-commands-bar">
                <span class="fav-label"><i class="fas fa-star"></i></span>
                <div
                  class="fav-commands-list"
                  id="favorite-commands-list"
                ></div>
              </div>

              <div class="console-container" id="logs"></div>

              <div class="console-input">
                <span class="console-prompt">&gt;</span>
                <input
                  type="text"
                  id="cmd-input"
                  placeholder="Entrez une commande..."
                  onkeydown="handleCommandInput(event)"
                />
                <button
                  class="btn-icon btn-fav"
                  onclick="addCurrentCommandToFavorites()"
                  title="Ajouter aux favoris"
                >
                  <i class="fas fa-star"></i>
                </button>
                <button class="btn-send" onclick="sendCommand()">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>

            <!-- Players -->
            <div id="view-players" class="view">
              <div class="players-header">
                <input
                  type="text"
                  id="player-search"
                  placeholder="Rechercher un joueur..."
                  class="search-input"
                />
              </div>
              <div class="players-grid" id="players-grid"></div>
            </div>

            <!-- Plugins -->
            <div id="view-plugins" class="view">
              <div class="plugins-header">
                <h3>Plugins Install√©s</h3>
                <button
                  class="btn-primary-large"
                  onclick="document.getElementById('plugin-upload').click()"
                >
                  <i class="fas fa-upload"></i> Importer un plugin
                </button>
                <input
                  type="file"
                  id="plugin-upload"
                  accept=".jar"
                  class="visually-hidden"
                  onchange="uploadPlugin(this.files[0])"
                />
              </div>
              <div class="plugins-grid" id="installed-plugins"></div>

              <div class="plugins-search-section">
                <h3>Rechercher des plugins</h3>
                <div class="search-bar">
                  <input
                    type="text"
                    id="plugin-search"
                    placeholder="Rechercher sur Hangar..."
                    onkeydown="if (event.key === 'Enter') searchPlugins();"
                  />
                  <button class="btn-search" onclick="searchPlugins()">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
                <div class="plugins-results-container">
                  <div class="plugins-grid" id="search-results"></div>
                </div>
              </div>
            </div>

            <!-- Config -->
            <div id="view-config" class="view">
              <div class="config-header">
                <h3>Configuration</h3>
                <div style="display: flex; gap: 8px; align-items: center">
                  <button class="btn-save-config" onclick="saveConfig()">
                    <i class="fas fa-save"></i> Enregistrer
                  </button>
                  <!-- Server meta (version/type) -->
                  <div
                    style="
                      display: flex;
                      gap: 6px;
                      align-items: center;
                      padding-left: 10px;
                    "
                  >
                    <input
                      id="server-meta-version"
                      placeholder="Version MC"
                      class="input-small"
                      style="width: 120px"
                    />
                    <select id="server-meta-type" class="select-small">
                      <option value="paper">Paper</option>
                      <option value="forge">Forge</option>
                      <option value="fabric">Fabric</option>
                      <option value="neoforge">NeoForge</option>
                      <option value="quilt">Quilt</option>
                    </select>
                    <input
                      id="server-meta-loader"
                      placeholder="Loader (opt.)"
                      class="input-small"
                      style="width: 120px"
                    />
                    <input
                      id="server-meta-forge"
                      placeholder="Forge (opt.)"
                      class="input-small"
                      style="width: 120px"
                    />
                    <button
                      class="btn-secondary"
                      onclick="saveServerMetaFromUI()"
                    >
                      Sauvegarder m√©ta
                    </button>
                  </div>
                </div>
              </div>

              <div
                class="config-section"
                style="
                  margin-bottom: 20px;
                  padding: 15px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 8px;
                "
              >
                <h4 style="margin-top: 0">
                  <i class="fas fa-magic"></i> Optimisation Automatique
                </h4>
                <p style="font-size: 0.9em; opacity: 0.7; margin-bottom: 10px">
                  Applique les "Aikar's Flags" (param√®tres Java optimis√©s) pour
                  am√©liorer les performances et r√©duire le lag.
                </p>
                <button
                  class="btn-primary"
                  onclick="optimizeServer()"
                  style="background: linear-gradient(135deg, #a855f7, #7c3aed)"
                >
                  <i class="fas fa-rocket"></i> Appliquer les Optimisations
                </button>
              </div>

              <!-- Docker Configuration Section -->
              <div
                id="docker-config-section"
                class="config-section"
                style="
                  margin-bottom: 20px;
                  padding: 15px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 8px;
                  display: none;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <h4 style="margin-top: 0">
                    <i class="fab fa-docker"></i> Ressources Docker
                  </h4>
                  <button class="btn-primary" onclick="saveDockerConfig()">
                    <i class="fas fa-save"></i> Mettre √† jour
                  </button>
                </div>

                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 10px;
                    margin-top: 10px;
                  "
                >
                  <div class="form-group">
                    <label>Port Host</label>
                    <input
                      id="d-port"
                      type="number"
                      class="config-input"
                      placeholder="25565"
                      style="
                        width: 100%;
                        padding: 8px;
                        background: #333;
                        border: 1px solid #555;
                        border-radius: 4px;
                        color: white;
                      "
                    />
                  </div>
                  <div class="form-group">
                    <label>RAM Max (Ex: 4G)</label>
                    <input
                      id="d-ram-max"
                      type="text"
                      class="config-input"
                      placeholder="2G"
                      style="
                        width: 100%;
                        padding: 8px;
                        background: #333;
                        border: 1px solid #555;
                        border-radius: 4px;
                        color: white;
                      "
                    />
                  </div>
                  <div class="form-group">
                    <label>RAM Init (Ex: 2G)</label>
                    <input
                      id="d-ram-min"
                      type="text"
                      class="config-input"
                      placeholder="1G"
                      style="
                        width: 100%;
                        padding: 8px;
                        background: #333;
                        border: 1px solid #555;
                        border-radius: 4px;
                        color: white;
                      "
                    />
                  </div>
                  <div class="form-group">
                    <label>CPU Limit (Ex: 2.0)</label>
                    <input
                      id="d-cpu"
                      type="text"
                      class="config-input"
                      placeholder="2.0"
                      style="
                        width: 100%;
                        padding: 8px;
                        background: #333;
                        border: 1px solid #555;
                        border-radius: 4px;
                        color: white;
                      "
                    />
                  </div>
                </div>
              </div>

              <h3>server.properties</h3>
              <div class="config-scroll-container">
                <div class="config-grid" id="config-grid"></div>
              </div>
            </div>

            <!-- Backups -->
            <div id="view-backups" class="view">
              <div class="backups-header">
                <h3>Sauvegardes</h3>
                <div class="backups-actions">
                  <button
                    class="btn-secondary-large"
                    onclick="openScheduleModal()"
                  >
                    <i class="fas fa-clock"></i> Planifier
                  </button>
                  <button class="btn-primary-large" onclick="backupServer()">
                    <i class="fas fa-plus"></i> Nouvelle sauvegarde
                  </button>
                </div>
              </div>
              <div class="backups-list" id="backups-list"></div>
            </div>

            <div id="view-mods" class="view" style="display: none">
              <div
                class="card-header"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <h3>
                  <i class="fas fa-cubes"></i> Gestionnaire de Mods (Modrinth)
                </h3>
                <button
                  class="btn-primary-sm"
                  onclick="document.getElementById('mod-upload-input').click()"
                >
                  <i class="fas fa-file-import"></i> Importer un mod
                </button>
                <input
                  type="file"
                  id="mod-upload-input"
                  accept=".jar"
                  style="display: none"
                  onchange="handleModUpload(this.files[0])"
                />
              </div>

              <div class="search-box">
                <input
                  type="text"
                  id="mods-search-input-panel"
                  placeholder="Rechercher un mod..."
                  onkeyup="if (event.key === 'Enter') searchMods(this.value);"
                />
                <button class="btn-primary" onclick="searchModsAdmin()">
                  <i class="fas fa-search"></i>
                </button>
              </div>

              <div class="mods-sections" style="margin-top: 20px">
                <div class="mods-section">
                  <h4>Mods Install√©s</h4>
                  <div
                    id="installed-mods-container"
                    class="settings-grid"
                    style="
                      display: grid;
                      grid-template-columns: repeat(
                        auto-fill,
                        minmax(280px, 1fr)
                      );
                      gap: 15px;
                      margin-bottom: 30px;
                    "
                  ></div>
                </div>

                <div class="mods-section">
                  <h4>R√©sultats de recherche</h4>
                  <div
                    id="mods-results-container"
                    class="settings-grid"
                    style="
                      display: grid;
                      grid-template-columns: repeat(
                        auto-fill,
                        minmax(280px, 1fr)
                      );
                      gap: 15px;
                    "
                  ></div>
                </div>
              </div>
            </div>

            <!-- Stats - Nouvelle section -->
            <div id="view-stats" class="view">
              <div class="stats-header">
                <h3>
                  <i class="fas fa-chart-bar"></i> Statistiques du serveur
                </h3>
                <button class="btn-secondary" onclick="refreshServerStats()">
                  <i class="fas fa-sync-alt"></i> Actualiser
                </button>
              </div>
              <div class="stats-dashboard">
                <div class="stats-row">
                  <div class="stats-card">
                    <div class="stats-icon"><i class="fas fa-clock"></i></div>
                    <div class="stats-value" id="stat-uptime">-</div>
                    <div class="stats-label">Temps de fonctionnement</div>
                  </div>
                  <div class="stats-card">
                    <div class="stats-icon"><i class="fas fa-users"></i></div>
                    <div class="stats-value" id="stat-total-players">-</div>
                    <div class="stats-label">Joueurs uniques</div>
                  </div>
                  <div class="stats-card">
                    <div class="stats-icon"><i class="fas fa-cube"></i></div>
                    <div class="stats-value" id="stat-world-size">-</div>
                    <div class="stats-label">Taille du monde</div>
                  </div>
                  <div class="stats-card">
                    <div class="stats-icon">
                      <i class="fas fa-puzzle-piece"></i>
                    </div>
                    <div class="stats-value" id="stat-plugins-count">-</div>
                    <div class="stats-label">Plugins install√©s</div>
                  </div>
                </div>
                <div class="stats-charts">
                  <div class="chart-container">
                    <h4>Performance (derni√®res 24h)</h4>
                    <canvas id="performance-chart"></canvas>
                  </div>
                  <div class="chart-container">
                    <h4>Joueurs connect√©s (derni√®res 24h)</h4>
                    <canvas id="players-chart"></canvas>
                  </div>
                </div>
                <div class="stats-top-players">
                  <h4><i class="fas fa-trophy"></i> Top Joueurs</h4>
                  <div class="top-players-grid" id="top-players-grid"></div>
                </div>
              </div>
            </div>

            <!-- Files - Nouvelle section -->
            <div id="view-files" class="view">
              <div class="files-header">
                <div class="files-breadcrumbs">
                  <button
                    class="btn-icon"
                    onclick="navigateFiles('..')"
                    title="Remonter"
                  >
                    <i class="fas fa-level-up-alt"></i>
                  </button>
                  <span id="files-current-path" class="path-display">/</span>
                </div>
                <div class="files-actions">
                  <button class="btn-sm" onclick="createNewFolder()">
                    <i class="fas fa-folder-plus"></i>
                    <span class="hide-mobile">Dossier</span>
                  </button>
                  <button class="btn-sm" onclick="createNewFile()">
                    <i class="fas fa-file-plus"></i>
                    <span class="hide-mobile">Fichier</span>
                  </button>
                  <button
                    class="btn-primary-sm"
                    onclick="
                      document.getElementById('file-upload-input').click()
                    "
                  >
                    <i class="fas fa-upload"></i>
                    <span class="hide-mobile">Upload</span>
                  </button>
                  <input
                    type="file"
                    id="file-upload-input"
                    multiple
                    style="display: none"
                    onchange="handleFileUpload(this.files)"
                  />
                </div>
              </div>
              <div class="files-container">
                <table class="files-table">
                  <thead>
                    <tr>
                      <th>Nom</th>
                      <th>Taille</th>
                      <th>Modifi√©</th>
                      <th style="text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="files-list-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SECTION: NOTIFICATIONS -->
      <section id="section-notifications" class="section">
        <div class="section-header">
          <h2><i class="fas fa-bell"></i> Notifications</h2>
          <button class="btn-secondary" onclick="markAllNotificationsRead()">
            <i class="fas fa-check-double"></i> Tout marquer lu
          </button>
        </div>
        <div class="notifications-list" id="notifications-list"></div>
      </section>

      <!-- SECTION: SETTINGS -->
      <section id="section-settings" class="section">
        <div class="section-header">
          <h2><i class="fas fa-sliders-h"></i> Param√®tres</h2>
        </div>

        <div class="settings-grid">
          <!-- CARTE PERFORMANCE -->
          <div class="settings-card perf-card">
            <div class="settings-card-header">
              <i class="fas fa-tachometer-alt"></i>
              <h3>Performance</h3>
            </div>
            <div class="settings-content">
              <div class="perf-modes">
                <label class="perf-mode-card">
                  <input
                    type="radio"
                    name="perf-mode"
                    value="eco"
                    id="perf-eco"
                    onchange="setPerformanceMode(this.value)"
                  />
                  <i class="fas fa-leaf"></i>
                  <span class="mode-name">ECO</span>
                  <span class="mode-desc">CPU minimal</span>
                </label>
                <label class="perf-mode-card">
                  <input
                    type="radio"
                    name="perf-mode"
                    value="balanced"
                    id="perf-balanced"
                    checked
                    onchange="setPerformanceMode(this.value)"
                  />
                  <i class="fas fa-balance-scale"></i>
                  <span class="mode-name">√âQUILIBR√â</span>
                  <span class="mode-desc">Recommand√©</span>
                </label>
                <label class="perf-mode-card">
                  <input
                    type="radio"
                    name="perf-mode"
                    value="gpu"
                    id="perf-gpu"
                    onchange="setPerformanceMode(this.value)"
                  />
                  <i class="fas fa-bolt"></i>
                  <span class="mode-name">MAX</span>
                  <span class="mode-desc">GPU requis</span>
                </label>
              </div>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-palette"></i>
              <h3>Apparence</h3>
            </div>
            <div class="settings-content">
              <div class="setting-row">
                <div class="setting-label">Th√®me</div>
                <div class="theme-toggle">
                  <button
                    class="theme-btn active"
                    data-theme="dark"
                    onclick="themeManager.set('dark')"
                  >
                    <i class="fas fa-moon"></i> Sombre
                  </button>
                  <button
                    class="theme-btn"
                    data-theme="light"
                    onclick="themeManager.set('light')"
                  >
                    <i class="fas fa-sun"></i> Clair
                  </button>
                </div>
              </div>
              <div class="setting-row">
                <label for="lang-select">Langue</label>
                <select
                  id="lang-select"
                  onchange="changeLanguage(this.value)"
                  class="setting-select"
                >
                  <option value="fr">üá´üá∑ Fran√ßais</option>
                  <option value="en">üá¨üáß English</option>
                  <option value="es">üá™üá∏ Espa√±ol</option>
                </select>
              </div>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-server"></i>
              <h3>Serveurs par d√©faut</h3>
            </div>
            <div class="settings-content">
              <div class="setting-row">
                <label for="default-ram">RAM par d√©faut (MB)</label>
                <input
                  type="number"
                  id="default-ram"
                  value="2048"
                  min="1024"
                  step="512"
                  class="setting-input"
                />
              </div>
              <div class="setting-row">
                <label for="default-port">Port par d√©faut</label>
                <input
                  type="number"
                  id="default-port"
                  value="25565"
                  min="1024"
                  max="65535"
                  class="setting-input"
                />
              </div>
              <div class="setting-row">
                <label for="autostart-toggle">D√©marrage auto</label>
                <label class="switch">
                  <input type="checkbox" id="autostart-toggle" />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- CHANGE PASSWORD -->
          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-user-cog"></i>
              <h3>Compte</h3>
            </div>
            <div class="settings-content">
              <div class="setting-row">
                <label>Email (optionnel)</label>
                <input
                  type="email"
                  id="account-email"
                  class="setting-input"
                  placeholder="votre@exemple.com"
                />
              </div>

              <div class="setting-row">
                <label>Ancien mot de passe</label>
                <input
                  type="password"
                  id="old-password"
                  class="setting-input"
                  placeholder="Ancien mot de passe"
                />
              </div>

              <div class="setting-row">
                <label>Nouveau mot de passe</label>
                <input
                  type="password"
                  id="new-password"
                  class="setting-input"
                  placeholder="Nouveau mot de passe"
                />
              </div>

              <div class="setting-row">
                <label>Confirmer le mot de passe</label>
                <input
                  type="password"
                  id="confirm-password"
                  class="setting-input"
                  placeholder="Confirmer le nouveau mot de passe"
                />
              </div>

              <div class="setting-row">
                <button class="btn-primary" onclick="changePassword()">
                  Changer le mot de passe
                </button>
              </div>

              <p class="settings-description">
                Le mot de passe doit contenir au moins 8 caract√®res, une
                majuscule et un chiffre.
              </p>
            </div>
          </div>

          <div class="settings-card settings-card-wide">
            <div class="settings-card-header">
              <i class="fas fa-globe"></i>
              <h3>Adresse de connexion</h3>
            </div>
            <div class="settings-content">
              <p class="settings-description">
                Configurez comment les joueurs se connectent √† vos serveurs.
                Utilisez un sous-domaine personnalis√© (comme Aternos) ou votre
                propre IP.
              </p>
              <div class="setting-row">
                <label>Mode sous-domaine</label>
                <label class="switch">
                  <input
                    type="checkbox"
                    id="use-subdomain"
                    onchange="toggleAddressMode()"
                  />
                  <span class="slider"></span>
                </label>
              </div>

              <div id="subdomain-config" style="display: none">
                <div class="setting-row">
                  <label>Votre domaine</label>
                  <input
                    type="text"
                    id="custom-domain"
                    placeholder="exemple: monserveur.fr"
                    class="setting-input"
                  />
                </div>
                <div class="address-preview">
                  <i class="fas fa-info-circle"></i>
                  <span
                    >Adresse de connexion:
                    <strong>[nom-serveur].monserveur.fr</strong></span
                  >
                </div>
                <p class="settings-hint">
                  <i class="fas fa-lightbulb"></i>
                  Configurez un enregistrement DNS wildcard (*.votredomaine.fr)
                  pointant vers votre IP.
                </p>
              </div>

              <div id="ip-config" class="settings-content">
                <div class="setting-row">
                  <label>IP publique ou domaine</label>
                  <input
                    type="text"
                    id="custom-ip"
                    placeholder="Ex: 192.168.1.100 ou play.monserveur.fr"
                    class="setting-input"
                  />
                </div>
                <button class="btn-secondary" onclick="detectPublicIP()">
                  <i class="fas fa-search"></i> D√©tecter mon IP
                </button>
              </div>

              <div class="setting-actions">
                <button class="btn-primary" onclick="saveAddressConfig()">
                  <i class="fas fa-save"></i> Sauvegarder
                </button>
              </div>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-bell"></i>
              <h3>Notifications</h3>
            </div>
            <div class="settings-content">
              <div class="setting-row">
                <label>Notifications navigateur</label>
                <label class="switch">
                  <input
                    type="checkbox"
                    id="browser-notif-toggle"
                    onchange="toggleBrowserNotifications(this.checked)"
                  />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-row">
                <label>Sons</label>
                <label class="switch">
                  <input type="checkbox" id="sounds-toggle" checked />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-row">
                <label>Discord Webhook</label>
                <div class="settings-content">
                  <input
                    type="text"
                    id="discord-webhook-settings"
                    placeholder="https://discord.com/api/webhooks/..."
                    class="setting-input"
                  />
                  <div
                    class="display: flex;align-items: center;justify-content: space-between;"
                  >
                    <button class="btn-primary" onclick="testDiscordSettings()">
                      Test
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-database"></i>
              <h3>Sauvegardes automatiques</h3>
            </div>
            <div class="settings-content">
              <div class="setting-row">
                <label>Activer</label>
                <label class="switch">
                  <input type="checkbox" id="auto-backup-toggle" />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-row">
                <label>Fr√©quence</label>
                <select id="backup-frequency" class="setting-select">
                  <option value="hourly">Toutes les heures</option>
                  <option value="daily" selected>Quotidien</option>
                  <option value="weekly">Hebdomadaire</option>
                </select>
              </div>
              <div class="setting-row">
                <label>R√©tention (jours)</label>
                <input
                  type="number"
                  id="backup-retention"
                  value="7"
                  min="1"
                  max="90"
                  class="setting-input"
                />
              </div>
              <div class="setting-row">
                <label>Compression</label>
                <label class="switch">
                  <input type="checkbox" id="backup-compress-toggle" checked />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-shield-alt"></i>
              <h3>S√©curit√©</h3>
            </div>
            <div class="settings-content">
              <div class="setting-row">
                <label>Session timeout (min)</label>
                <input
                  type="number"
                  id="session-timeout"
                  value="60"
                  min="5"
                  max="480"
                  class="setting-input"
                />
              </div>
              <div class="setting-row">
                <label>Double authentification</label>
                <label class="switch">
                  <input type="checkbox" id="2fa-toggle" />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="setting-row">
                <label>Logs de connexion</label>
                <label class="switch">
                  <input type="checkbox" id="login-logs-toggle" checked />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>

          <div class="settings-card admin-only" id="users-settings">
            <div class="settings-card-header">
              <i class="fas fa-users-cog"></i>
              <h3>Utilisateurs</h3>
              <button class="btn-sm" onclick="openUserModal()">
                <i class="fas fa-plus"></i> Ajouter
              </button>
            </div>
            <div class="settings-content">
              <div class="users-list" id="users-list"></div>
            </div>
          </div>

          <!-- Docker installer (admin only) -->
          <div class="settings-card admin-only" id="docker-installer-settings">
            <div class="settings-card-header">
              <i class="fas fa-docker"></i>
              <h3>Docker</h3>
            </div>
            <div class="settings-content">
              <div class="setting-row">
                <label>Statut</label>
                <div>
                  <span id="docker-status" class="text-muted"
                    >V√©rification...</span
                  >
                </div>
              </div>
              <div class="setting-row">
                <label>Installer Docker</label>
                <div>
                  <button
                    id="install-docker-btn"
                    class="btn-primary"
                    onclick="installDockerUI()"
                  >
                    Installer Docker
                  </button>
                  <button
                    id="install-docker-sync-btn"
                    class="btn"
                    onclick="installDockerUI(false)"
                  >
                    Synchronique
                  </button>
                </div>
                <div style="margin-top: 8px; font-size: 0.9rem; color: #666">
                  L'installation n√©cessite des privil√®ges sudo/administrateur
                  sur la machine.
                </div>
              </div>
              <div class="setting-row">
                <label>Dernier log</label>
                <div>
                  <a
                    id="docker-log-link"
                    href="#"
                    target="_blank"
                    style="display: none"
                    >Voir le log d'installation</a
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <i class="fas fa-info-circle"></i>
              <h3>√Ä propos</h3>
            </div>
            <div class="settings-content">
              <div class="about-info">
                <p><strong>MCPanel</strong> v0.2.5</p>
                <p>Gestionnaire de serveurs Minecraft</p>
                <p class="text-muted">¬© 2026 - Tous droits r√©serv√©s</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- MODALS -->
    <div id="create-modal" class="modal">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2><i class="fas fa-plus-circle"></i> Nouveau Serveur</h2>
          <button class="btn-close" onclick="closeModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form onsubmit="createServer(event)">
          <div class="form-group">
            <label>Nom du serveur</label>
            <input
              type="text"
              id="server-name-input"
              placeholder="mon-serveur"
              required
              pattern="[A-Za-z0-9_\-]+"
              class="input-large"
            />
          </div>
          <div class="form-group">
            <label>Port du serveur</label>
            <div class="input-with-button">
              <input
                type="number"
                id="server-port-input"
                placeholder="25565"
                class="input-large"
                min="1024"
                max="65535"
              />
              <button
                type="button"
                class="btn-secondary"
                onclick="suggestPort()"
                title="Sugg√©rer un port libre"
              >
                <i class="fas fa-magic"></i>
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Version Minecraft</label>
            <select id="server-version" required class="select-large"></select>
          </div>
          <div class="form-group">
            <label>Type de serveur</label>
            <select
              id="server-type"
              class="select-large"
              onchange="onServerTypeChangeDebounced()"
            >
              <option value="paper">Paper</option>
              <option value="forge">Forge</option>
              <option value="fabric">Fabric</option>
              <option value="neoforge">NeoForge</option>
              <option value="quilt">Quilt</option>
            </select>
          </div>

          <div
            class="form-group"
            id="forge-version-group"
            style="display: none"
          >
            <label>Version Forge</label>
            <select id="forge-version" class="select-large"></select>
          </div>

          <div
            class="form-group"
            id="fabric-loader-group"
            style="display: none"
          >
            <label>Loader Fabric</label>
            <select id="fabric-loader" class="select-large"></select>
          </div>

          <!-- Mods selection removed from creation modal -->

          <div class="form-group" id="mod-job-status" style="display: none">
            <label>Statut d'installation</label>
            <div id="job-status-box">
              Job: <span id="job-id-display">-</span>
              <span id="job-status-text">-</span>
            </div>
            <div id="job-logs" class="job-logs"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>RAM Min (MB)</label>
              <input
                type="number"
                id="ram-min"
                value="1024"
                min="512"
                step="256"
                required
                class="input-large"
              />
            </div>
            <div class="form-group">
              <label>RAM Max (MB)</label>
              <input
                type="number"
                id="ram-max"
                value="2048"
                min="1024"
                step="256"
                required
                class="input-large"
              />
            </div>
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary-large"
              onclick="closeModal()"
            >
              Annuler
            </button>
            <button type="submit" class="btn-primary-large btn-create-server">
              <i class="fas fa-rocket"></i> Cr√©er le serveur
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Player Details Modal -->
    <div id="player-modal" class="modal">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <div class="player-modal-header">
            <img
              id="player-modal-avatar"
              src=""
              alt=""
              class="player-modal-avatar"
            />
            <div>
              <h2 id="player-modal-name">Joueur</h2>
              <span id="player-modal-uuid" class="text-muted"></span>
            </div>
          </div>
          <button class="btn-close" onclick="closePlayerModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="player-modal-body">
          <!-- Player Stats avec contr√¥les interactifs -->
          <div class="player-stats-section">
            <h4><i class="fas fa-heart-pulse"></i> Statistiques vitales</h4>

            <!-- Barre de vie interactive -->
            <div class="vital-stat-row">
              <div class="vital-stat-label">
                <i class="fas fa-heart" style="color: #ff5555"></i>
                <span>Vie</span>
              </div>
              <div class="vital-stat-content" id="player-health-container">
                <span id="player-health">20</span>/20
              </div>
            </div>

            <!-- Barre de faim interactive -->
            <div class="vital-stat-row">
              <div class="vital-stat-label">
                <i class="fas fa-drumstick-bite" style="color: #ffaa00"></i>
                <span>Faim</span>
              </div>
              <div class="vital-stat-content" id="player-food-container">
                <span id="player-food">20</span>/20
              </div>
            </div>
          </div>

          <!-- Autres stats -->
          <div class="player-stats-grid">
            <div class="player-stat-card">
              <i class="fas fa-star" style="color: #55ff55"></i>
              <div class="stat-info">
                <span class="stat-value" id="player-xp">0</span>
                <span class="stat-label">Niveau XP</span>
              </div>
            </div>
            <div class="player-stat-card">
              <i class="fas fa-map-marker-alt" style="color: #55ffff"></i>
              <div class="stat-info">
                <span class="stat-value" id="player-pos">N/A</span>
                <span class="stat-label">Position</span>
              </div>
            </div>
            <div class="player-stat-card">
              <i class="fas fa-clock" style="color: #ffff55"></i>
              <div class="stat-info">
                <span class="stat-value" id="player-playtime">0h</span>
                <span class="stat-label">Temps de jeu</span>
              </div>
            </div>
            <div class="player-stat-card">
              <i class="fas fa-skull" style="color: #aaaaaa"></i>
              <div class="stat-info">
                <span class="stat-value" id="player-deaths">0</span>
                <span class="stat-label">Morts</span>
              </div>
            </div>
          </div>

          <!-- Player Actions -->
          <div class="player-actions-bar">
            <button
              class="btn-action-op"
              onclick="playerAction(currentPlayerName, 'op')"
            >
              <i class="fas fa-crown"></i> OP
            </button>
            <button
              class="btn-action-deop"
              onclick="playerAction(currentPlayerName, 'deop')"
            >
              <i class="fas fa-crown"></i> Deop
            </button>
            <button
              class="btn-action-gm"
              onclick="playerAction(currentPlayerName, 'gm_s')"
            >
              <i class="fas fa-shield-alt"></i> Survie
            </button>
            <button
              class="btn-action-gm"
              onclick="playerAction(currentPlayerName, 'gm_c')"
            >
              <i class="fas fa-cube"></i> Cr√©atif
            </button>
            <button
              class="btn-action-warn"
              onclick="playerAction(currentPlayerName, 'kick')"
            >
              <i class="fas fa-sign-out-alt"></i> Kick
            </button>
            <button
              class="btn-action-danger"
              onclick="playerAction(currentPlayerName, 'ban')"
            >
              <i class="fas fa-ban"></i> Ban
            </button>
            <button
              class="btn-action-danger"
              onclick="playerAction(currentPlayerName, 'kill')"
            >
              <i class="fas fa-skull-crossbones"></i> Kill
            </button>
            <button
              class="btn-action-warn"
              onclick="playerAction(currentPlayerName, 'clear')"
            >
              <i class="fas fa-trash"></i> Clear
            </button>
          </div>

          <!-- Inventory Tabs -->
          <div class="inventory-tabs">
            <button
              class="inv-tab active"
              onclick="switchInventoryTab('inventory', this)"
            >
              <i class="fas fa-box"></i> Inventaire
            </button>
            <button
              class="inv-tab"
              onclick="switchInventoryTab('enderchest', this)"
            >
              <i class="fas fa-chest"></i> Enderchest
            </button>
            <button class="inv-tab" onclick="switchInventoryTab('armor', this)">
              <i class="fas fa-shield-alt"></i> Armure
            </button>
          </div>

          <!-- Inventory Grid -->
          <div id="inventory-view" class="inventory-container">
            <div id="player-inventory"></div>
          </div>
          <div
            id="enderchest-view"
            class="inventory-container"
            style="display: none"
          >
            <div id="player-enderchest"></div>
          </div>
          <div
            id="armor-view"
            class="inventory-container"
            style="display: none"
          >
            <div class="armor-display" id="player-armor"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="schedule-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-calendar-alt"></i> Planifier sauvegardes</h2>
          <button class="btn-close" onclick="closeScheduleModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form onsubmit="saveSchedule(event)">
          <div class="form-group">
            <label>Fr√©quence</label>
            <select id="schedule-type">
              <option value="hourly">Toutes les heures</option>
              <option value="daily" selected>Quotidien</option>
              <option value="weekly">Hebdomadaire</option>
            </select>
          </div>
          <div class="form-group">
            <label>R√©tention</label>
            <input
              type="number"
              id="schedule-retention"
              value="7"
              min="1"
              max="30"
            />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeScheduleModal()"
            >
              Annuler
            </button>
            <button type="submit" class="btn-primary">
              <i class="fas fa-save"></i> Enregistrer
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tunnel Modal -->
    <div id="tunnel-modal" class="modal">
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h2>
            <i class="fas fa-network-wired"></i>
            <span data-i18n="tunnel.title">Tunnel de partage</span>
          </h2>
          <button class="btn-close" onclick="closeTunnelModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="tunnel-modal-body">
          <!-- Tunnel Status -->
          <div id="tunnel-status" class="tunnel-status">
            <div class="tunnel-status-icon">
              <i class="fas fa-circle-notch fa-spin"></i>
            </div>
            <div class="tunnel-status-info">
              <span class="tunnel-status-text" data-i18n="tunnel.inactive"
                >Aucun tunnel actif</span
              >
              <span class="tunnel-provider-name"></span>
            </div>
          </div>

          <!-- Active Tunnel Address -->
          <div
            id="tunnel-address-box"
            class="tunnel-address-box"
            style="display: none"
          >
            <div class="tunnel-address-label">
              <i class="fas fa-link"></i>
              <span data-i18n="tunnel.copy_address">Adresse de connexion</span>
            </div>
            <div class="tunnel-address-value">
              <input type="text" id="tunnel-address" readonly />
              <button
                class="btn-copy"
                onclick="copyTunnelAddress()"
                data-i18n-title="actions.copy"
              >
                <i class="fas fa-copy"></i>
              </button>
            </div>
            <p class="tunnel-hint" data-i18n="tunnel.description">
              Partagez cette adresse avec vos amis pour qu'ils rejoignent votre
              serveur !
            </p>
          </div>

          <!-- Provider Selection -->
          <div class="tunnel-providers">
            <h4>
              <i class="fas fa-server"></i>
              <span data-i18n="tunnel.select_provider"
                >Choisir un fournisseur</span
              >
            </h4>
            <div class="provider-grid">
              <button
                type="button"
                class="provider-card"
                onclick="startTunnel('localhost_run')"
              >
                <div class="provider-icon">
                  <i class="fas fa-rocket"></i>
                </div>
                <div class="provider-info">
                  <span class="provider-name" data-i18n="tunnel.localhost_run"
                    >localhost.run</span
                  >
                  <span class="provider-desc">SSH tunnel rapide</span>
                </div>
                <div class="provider-badge">Recommand√©</div>
              </button>
              <button
                type="button"
                class="provider-card"
                onclick="startTunnel('bore')"
              >
                <div class="provider-icon">
                  <i class="fas fa-bolt"></i>
                </div>
                <div class="provider-info">
                  <span class="provider-name" data-i18n="tunnel.bore"
                    >Bore</span
                  >
                  <span class="provider-desc">TCP tunnel l√©ger</span>
                </div>
              </button>
              <button
                type="button"
                class="provider-card"
                onclick="startTunnel('serveo')"
              >
                <div class="provider-icon">
                  <i class="fas fa-globe"></i>
                </div>
                <div class="provider-info">
                  <span class="provider-name" data-i18n="tunnel.serveo"
                    >Serveo</span
                  >
                  <span class="provider-desc">SSH alternatif</span>
                </div>
              </button>
              <button
                type="button"
                class="provider-card"
                onclick="startTunnel('cloudflared')"
              >
                <div class="provider-icon">
                  <i class="fas fa-cloud"></i>
                </div>
                <div class="provider-info">
                  <span class="provider-name" data-i18n="tunnel.cloudflared"
                    >Cloudflare</span
                  >
                  <span class="provider-desc">Tunnel s√©curis√©</span>
                </div>
              </button>
              <button
                type="button"
                class="provider-card"
                onclick="showManualTunnel()"
              >
                <div class="provider-icon">
                  <i class="fas fa-cog"></i>
                </div>
                <div class="provider-info">
                  <span class="provider-name" data-i18n="tunnel.manual"
                    >Manuel</span
                  >
                  <span class="provider-desc" data-i18n="tunnel.manual_desc"
                    >Port forwarding</span
                  >
                </div>
              </button>
            </div>
          </div>

          <!-- Manual Config -->
          <div
            id="manual-tunnel-config"
            class="manual-config"
            style="display: none"
          >
            <div class="form-group">
              <label data-i18n="tunnel.copy_address">Adresse publique</label>
              <input
                type="text"
                id="manual-address"
                placeholder="ex: votre-ip:25565"
              />
            </div>
            <button class="btn-primary" onclick="setManualTunnel()">
              <i class="fas fa-check"></i>
              <span data-i18n="actions.confirm">Appliquer</span>
            </button>
          </div>

          <!-- Tunnel Actions -->
          <div id="tunnel-actions" class="tunnel-actions" style="display: none">
            <button class="btn-danger" onclick="stopTunnel()">
              <i class="fas fa-stop"></i>
              <span data-i18n="tunnel.stop">Arr√™ter le tunnel</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="user-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-user-plus"></i> Nouvel utilisateur</h2>
          <button class="btn-close" onclick="closeUserModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form onsubmit="createUser(event)">
          <div class="form-group">
            <label>Nom d'utilisateur</label>
            <input type="text" id="new-username" required />
          </div>
          <div class="form-group">
            <label>Mot de passe</label>
            <input
              type="password"
              id="new-user-password"
              required
              minlength="4"
            />
          </div>
          <div class="form-group">
            <label>R√¥le</label>
            <select id="new-role">
              <option value="user">Utilisateur</option>
              <option value="admin">Administrateur</option>
            </select>
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeUserModal()"
            >
              Annuler
            </button>
            <button type="submit" class="btn-primary">
              <i class="fas fa-save"></i> Cr√©er
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- File Editor Modal -->
    <div id="file-editor-modal" class="modal">
      <div class="modal-content modal-xl">
        <div class="modal-header">
          <h2>
            <i class="fas fa-edit"></i>
            <span id="editor-filename">Editeur</span>
          </h2>
          <div class="editor-actions">
            <button class="btn-primary" onclick="saveFileContent()">
              <i class="fas fa-save"></i> Enregistrer
            </button>
            <button class="btn-close" onclick="closeFileEditor()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="editor-body">
          <textarea
            id="file-content-editor"
            class="code-editor"
            spellcheck="false"
          ></textarea>
        </div>
      </div>
    </div>
    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal">
      <div class="modal-content small-modal">
        <div class="modal-header">
          <h3><i class="fas fa-cog"></i> Param√®tres</h3>
          <button class="btn-close" onclick="closeSettings()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Theme -->
          <div class="form-group">
            <label><i class="fas fa-palette"></i> Apparence</label>
            <div class="theme-switcher">
              <button class="theme-btn" onclick="themeManager.set('dark')">
                <i class="fas fa-moon"></i> Sombre
              </button>
              <button class="theme-btn" onclick="themeManager.set('light')">
                <i class="fas fa-sun"></i> Clair
              </button>
            </div>
          </div>

          <div class="form-group">
            <label
              ><i class="fas fa-paint-brush"></i> Couleur d'accentuation</label
            >
            <div class="color-picker-grid">
              <button
                class="color-swatch"
                style="background: #6c5ce7"
                onclick="themeManager.setColor('#6c5ce7')"
              ></button>
              <button
                class="color-swatch"
                style="background: #0984e3"
                onclick="themeManager.setColor('#0984e3')"
              ></button>
              <button
                class="color-swatch"
                style="background: #00b894"
                onclick="themeManager.setColor('#00b894')"
              ></button>
              <button
                class="color-swatch"
                style="background: #e17055"
                onclick="themeManager.setColor('#e17055')"
              ></button>
              <button
                class="color-swatch"
                style="background: #d63031"
                onclick="themeManager.setColor('#d63031')"
              ></button>
              <button
                class="color-swatch"
                style="background: #e84393"
                onclick="themeManager.setColor('#e84393')"
              ></button>
            </div>
          </div>

          <!-- Notifications -->
          <div class="form-group">
            <label><i class="fab fa-discord"></i> Notifications Discord</label>
            <div
              style="
                background: rgba(0, 0, 0, 0.2);
                padding: 15px;
                border-radius: 8px;
              "
            >
              <div class="form-group-checkbox" style="margin-bottom: 10px">
                <label class="switch">
                  <input type="checkbox" id="discord-enabled" />
                  <span class="slider round"></span>
                </label>
                <span>Activer</span>
              </div>

              <div class="input-group">
                <input
                  type="text"
                  id="discord-webhook"
                  placeholder="https://discord.com/api/webhooks/..."
                  style="
                    width: 100%;
                    padding: 8px;
                    border-radius: 4px;
                    border: 1px solid #444;
                    background: #222;
                    color: #fff;
                  "
                />
              </div>

              <div style="display: flex; gap: 10px; margin-top: 10px">
                <button
                  class="btn-secondary"
                  onclick="testDiscordWebhook()"
                  style="flex: 1"
                >
                  Tester
                </button>
                <button
                  class="btn-primary"
                  onclick="saveNotificationConfig()"
                  style="flex: 1"
                >
                  Sauvegarder
                </button>
              </div>
            </div>
          </div>

          <!-- Admin: Governance -->
          <div
            id="admin-governance-section"
            style="
              display: none;
              border-top: 1px solid rgba(255, 255, 255, 0.1);
              margin-top: 20px;
              padding-top: 20px;
            "
          >
            <label><i class="fas fa-gavel"></i> Gouvernance (Admin)</label>
            <div class="form-group-checkbox" style="margin-top: 10px">
              <label class="switch">
                <input
                  type="checkbox"
                  id="admin-allow-resource-edit"
                  onchange="saveAdminQuotas()"
                />
                <span class="slider round"></span>
              </label>
              <span>Autoriser les utilisateurs √† modifier RAM/CPU/Ports</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="mod-versions-modal" class="modal">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3 id="mod-versions-title">Versions du Mod</h3>
          <button class="close-btn" onclick="closeModVersionsModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div id="mod-versions-list" class="versions-list">
            <div class="loading-state">
              <i class="fas fa-spinner fa-spin"></i> Chargement des versions...
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast-container"></div>

    <!-- Main loader for modularized MCP scripts (created by refactor) -->
    <!-- marketplace client logic -->
    <script>
      function handleEnter(e) {
        if (e.key === "Enter") searchMarket();
      }
      async function searchMarket() {
        const query = document.getElementById("marketSearch").value;
        if (!query) return;
        document.getElementById("marketResults").innerHTML = "";
        document.getElementById("marketLoading").classList.remove("d-none");
        try {
          const res = await fetch(
            `/api/market/search?q=${encodeURIComponent(query)}`,
          );
          const data = await res.json();
          document.getElementById("marketLoading").classList.add("d-none");
          if (data.status === "success" && data.results.length > 0) {
            renderResults(data.results);
          } else {
            document.getElementById("marketResults").innerHTML =
              '<div class="col-12 text-center"><p>Aucun r√©sultat trouv√©.</p></div>';
          }
        } catch (e) {
          console.error(e);
          document.getElementById("marketLoading").classList.add("d-none");
          alert("Erreur lors de la recherche");
        }
      }
      function renderResults(items) {
        const container = document.getElementById("marketResults");
        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "col-md-4 mb-4";
          card.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <img src="${item.icon || "https://via.placeholder.com/64"}" style="width: 48px; height: 48px; object-fit: contain;" class="mr-3">
                            <h5 class="card-title mb-0 text-truncate">${item.title}</h5>
                        </div>
                        <p class="card-text small text-muted" style="height: 60px; overflow: hidden;">${item.desc}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge badge-info">${item.author}</span>
                            <span class="small"><i class="fas fa-download"></i> ${item.downloads}</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-sm btn-outline-success btn-block" onclick="showInstallModal('${item.id}', '${item.title.replace(/'/g, "\\'")}')">Installer</button>
                    </div>
                </div>
            `;
          container.appendChild(card);
        });
      }
      async function showInstallModal(id, title) {
        currentProjectId = id;
        document.getElementById("installTitle").innerText = title;
        const status = document.getElementById("installStatus");
        status.className = "alert d-none";
        $("#installModal").modal("show");
        const select = document.getElementById("serverSelect");
        select.innerHTML = '<option value="">Chargement...</option>';
        try {
          const res = await fetch("/api/servers");
          const data = await res.json();
          select.innerHTML = "";
          if (data.status === "success" && data.servers.length > 0) {
            data.servers.forEach((s) => {
              const opt = document.createElement("option");
              opt.value = s.name;
              opt.innerText = s.name;
              select.appendChild(opt);
            });
          } else {
            select.innerHTML = '<option value="">Aucun serveur trouv√©</option>';
          }
        } catch (e) {
          select.innerHTML =
            '<option value="">Erreur chargement serveurs</option>';
        }
      }
      document.getElementById("confirmInstallBtn").onclick = async function () {
        const serverName = document.getElementById("serverSelect").value;
        if (!serverName) return alert("S√©lectionnez un serveur");
        const btn = this;
        btn.disabled = true;
        btn.innerText = "Installation...";
        try {
          const res = await fetch("/api/market/install", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              project_id: currentProjectId,
              server_name: serverName,
            }),
          });
          const data = await res.json();
          const status = document.getElementById("installStatus");
          status.classList.remove("d-none");
          if (data.status === "success") {
            status.className = "alert alert-success";
            status.innerText = "Installation r√©ussie !";
            setTimeout(() => $("#installModal").modal("hide"), 2000);
          } else {
            status.className = "alert alert-danger";
            status.innerText = "Erreur : " + data.message;
          }
        } catch (e) {
          alert("Erreur r√©seau");
        } finally {
          btn.disabled = false;
        }
      };
      // placeholder variable for install
      let currentProjectId = null;

      /* Docker management helper */
      function installDocker() {
        if (confirm("Lancer l'installation automatique de Docker ?")) {
          fetch("/api/system/install-docker", { method: "POST" })
            .then((res) => res.json())
            .then((data) => alert(data.message));
        }
      }
      function pruneDocker() {
        if (confirm("Supprimer toutes les images non utilis√©es ?")) {
          alert("Commande envoy√©e");
        }
      }
      function loadDocker() {
        // fetch container list via API and populate table
        fetch("/api/docker/containers")
          .then((r) => r.json())
          .then((data) => {
            const tbody = document.querySelector("#docker-table tbody");
            tbody.innerHTML = "";
            if (data.containers && data.containers.length) {
              data.containers.forEach((c) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td><strong>${c.name}</strong><br/><small class="text-muted">${c.id}</small></td>
                                <td>${c.status_text}</td>
                                <td>${c.image}</td>
                                <td><span class="badge badge-${c.state == "running" ? "success" : "secondary"}">${c.state}</span></td>
                                <td><a href="/server/${c.name}" class="btn btn-sm btn-primary">G√©rer</a>
                                    <button class="btn btn-sm btn-info" onclick="showLogs('${c.name}')">Logs</button></td>`;
                tbody.appendChild(tr);
              });
              document.getElementById("docker-count").innerText =
                data.containers.length;
              document.getElementById("docker-content").style.display = "";
              document.getElementById("docker-warning").style.display = "none";
            } else {
              document.getElementById("docker-warning").style.display = "";
              document.getElementById("docker-content").style.display = "none";
            }
          })
          .catch((e) => {
            console.error("docker load error", e);
            document.getElementById("docker-warning").style.display = "";
          });
      }

      let swarmRefreshInterval = null;
      async function loadSwarm() {
        try {
          // clear previous timer to avoid overlaps
          if (swarmRefreshInterval) clearTimeout(swarmRefreshInterval);
          const [statusRes, configRes] = await Promise.all([
            fetch("/swarm/status"),
            fetch("/swarm/config"),
          ]);
          const data = await statusRes.json();
          document.getElementById("swarm-status-text").innerText = data.active
            ? "Actif"
            : "Inactif";
          const list = document.getElementById("swarm-nodes-list");
          const table = document.getElementById("swarm-node-table");
          list.innerHTML = "";
          table.innerHTML = "";
          (data.nodes || []).forEach((node) => {
            const li = document.createElement("li");
            li.innerText = `${node.hostname} - ${node.role} (${node.status})`;
            list.appendChild(li);
            const tr = document.createElement("tr");
            // determine possible role action
            let actions = `<button class="btn btn-sm btn-info" onclick="showNodeDetails('${node.hostname}', ${JSON.stringify(node)})">D√©tails</button>`;
            if (node.role && node.role.toLowerCase() === "worker") {
              actions += ` <button class="btn btn-sm btn-success admin-only" onclick="promoteNode('${node.hostname}')">Promouvoir</button>`;
            } else if (node.role && node.role.toLowerCase() === "manager") {
              actions += ` <button class="btn btn-sm btn-warning admin-only" onclick="demoteNode('${node.hostname}')">D√©motionner</button>`;
            }
            actions += ` <button class="btn btn-sm btn-danger admin-only" onclick="removeNode('${node.hostname}')">Supprimer</button>`;
            tr.innerHTML = `<td>${node.hostname}</td><td>${node.role}</td><td>${node.status}</td><td>${node.cpu || "n/a"}/${node.ram || "n/a"}</td><td>${actions}</td>`;
            table.appendChild(tr);
          });
          // reapply UI permissions in case new elements were added
          if (typeof updateUserUI === "function") updateUserUI();
          // populate config form
          if (configRes.ok) {
            const cfg = await configRes.json();
            document.getElementById("swarmMode").value = cfg.mode || "local";
            document.getElementById("swarmSSHHost").value = cfg.ssh_host || "";
            document.getElementById("swarmSSHUser").value = cfg.ssh_user || "";
            document.getElementById("swarmSSHKey").value =
              cfg.ssh_key_path || "";
            document.getElementById("swarmRegistry").value =
              cfg.registry_domain || "";
            document.getElementById("swarmNfsIp").value =
              cfg.nfs_server_ip || "";
            document.getElementById("swarmNfsPath").value = cfg.nfs_path || "";
            toggleSwarmFields();
          }
        } catch (e) {
          console.error("swarm load error", e);
        }
        // refresh again in 10 seconds
        swarmRefreshInterval = setTimeout(loadSwarm, 10000);
      }

      function toggleSwarmFields() {
        const mode = document.getElementById("swarmMode").value;
        const sshFields = ["swarmSSHHost", "swarmSSHUser", "swarmSSHKey"];
        sshFields.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.disabled = mode !== "remote";
        });
      }

      async function saveSwarmConfig() {
        const cfg = {
          mode: document.getElementById("swarmMode").value,
          ssh_host: document.getElementById("swarmSSHHost").value,
          ssh_user: document.getElementById("swarmSSHUser").value,
          ssh_key_path: document.getElementById("swarmSSHKey").value,
          registry_domain: document.getElementById("swarmRegistry").value,
          nfs_server_ip: document.getElementById("swarmNfsIp").value,
          nfs_path: document.getElementById("swarmNfsPath").value,
        };

        // simple validation
        if (cfg.mode === "remote") {
          if (!cfg.ssh_host || !cfg.ssh_user) {
            showToast("error", "SSH host et user requis pour le mode remote");
            return;
          }
        }

        try {
          const res = await fetch("/swarm/save_config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": getCsrfToken(),
            },
            body: JSON.stringify(cfg),
          });
          const data = await res.json();
          if (data.status === "success") {
            showToast("success", data.message);
            loadSwarm();
          } else {
            showToast("error", data.message || "Erreur sauvegarde");
          }
        } catch (e) {
          console.error("saveSwarmConfig error", e);
          showToast("error", "Erreur sauvegarde");
        }
      }

      function showAddNodeModal() {
        fetch("/swarm/nodes/token")
          .then((r) => r.json())
          .then((data) => {
            if (data.status === "success") {
              document.getElementById("join-command").innerText = data.command;
              $("#addNodeModal").modal("show");
            } else {
              showToast(
                "error",
                data.message || "Impossible de r√©cup√©rer le token",
              );
            }
          })
          .catch((e) => {
            console.error("join token error", e);
            showToast("error", "Erreur r√©cup√©ration token");
          });
      }

      function copyJoinCommand() {
        const txt = document.getElementById("join-command").innerText;
        navigator.clipboard
          .writeText(txt)
          .then(() => {
            showToast("success", "Commande copi√©e");
          })
          .catch(() => {
            showToast("error", "Impossible de copier");
          });
      }

      function showNodeDetails(hostname, data) {
        const pre = document.getElementById("node-details-content");
        if (pre) {
          pre.textContent = JSON.stringify(data, null, 2);
        }
        $("#nodeDetailsModal").modal("show");
      }

      async function promoteNode(hostname) {
        try {
          const res = await fetch("/swarm/nodes/promote", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": getCsrfToken(),
            },
            body: JSON.stringify({ hostname }),
          });
          const d = await res.json();
          if (d.status === "success") {
            showToast("success", "Noeud promu");
            loadSwarm();
          } else {
            showToast("error", d.message || "Erreur promotion");
          }
        } catch (e) {
          console.error("promoteNode error", e);
          showToast("error", "Erreur promotion");
        }
      }

      async function demoteNode(hostname) {
        try {
          const res = await fetch("/swarm/nodes/demote", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": getCsrfToken(),
            },
            body: JSON.stringify({ hostname }),
          });
          const d = await res.json();
          if (d.status === "success") {
            showToast("success", "Noeud d√©motionn√©");
            loadSwarm();
          } else {
            showToast("error", d.message || "Erreur d√©motion");
          }
        } catch (e) {
          console.error("demoteNode error", e);
          showToast("error", "Erreur d√©motion");
        }
      }

      async function removeNode(hostname) {
        if (!confirm(`Supprimer le noeud ${hostname} ?`)) return;
        try {
          const res = await fetch("/swarm/nodes/remove", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": getCsrfToken(),
            },
            body: JSON.stringify({ hostname }),
          });
          const d = await res.json();
          if (d.status === "success") {
            showToast("success", "Noeud supprim√©");
            loadSwarm();
          } else {
            showToast("error", d.message || "Erreur suppression");
          }
        } catch (e) {
          console.error("removeNode error", e);
          showToast("error", "Erreur suppression");
        }
      }

      // ensure fields state is correct at startup
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof toggleSwarmFields === "function") toggleSwarmFields();
      });
    </script>
    <!-- Swarm Add Node Modal -->
    <div class="modal fade" id="addNodeModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ajouter un noeud au Swarm</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>
              Pour joindre un nouveau noeud, ex√©cutez sur la machine cible :
            </p>
            <pre
              id="join-command"
              style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd"
            ></pre>
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="copyJoinCommand()"
            >
              Copier la commande
            </button>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Swarm Node Details Modal -->
    <div class="modal fade" id="nodeDetailsModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">D√©tails du noeud</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <pre
              id="node-details-content"
              style="background: #f0f0f0; padding: 10px"
            ></pre>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="/static/js/main.js"></script>
  </body>
</html>
