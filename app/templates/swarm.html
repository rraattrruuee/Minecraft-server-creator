<!doctype html>
<html lang="fr" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>MCPanel - Swarm Infrastructure</title>
    <link rel="stylesheet" href="/static/style_clean.css" />
    <link rel="stylesheet" href="/static/libs/fontawesome/css/all.min.css" />
    <style>
      .container-fluid {
        padding: 20px;
      }
      .card {
        background: var(--bg-card);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .status-badge {
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
      }
      .status-active {
        background: #2ecc71;
        color: white;
      }
      .status-inactive {
        background: #e74c3c;
        color: white;
      }
      code {
        background: #333;
        padding: 2px 5px;
        border-radius: 3px;
      }
      pre {
        background: #222;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <!-- Simple simplified nav since we don't include base.html -->
    <div style="display: flex; height: 100vh">
      <aside
        class="sidebar"
        style="width: 250px; background: var(--bg-sidebar); padding: 10px"
      >
        <div class="logo" style="margin-bottom: 20px">
          <i class="fas fa-cubes"></i>
          <h1>MCPanel</h1>
        </div>
        <a href="/" class="nav-item"><i class="fas fa-home"></i> Accueil</a>
        <a href="/swarm/" class="nav-item active"
          ><i class="fas fa-network-wired"></i> Infrastructure</a
        >
      </aside>

      <main style="flex: 1; padding: 20px; overflow-y: auto">
        <h1>Dashboard Infrastructure (Swarm)</h1>

        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <h2>
                  <i class="fas fa-server"></i> Gestion des Machines (Noeuds)
                </h2>
                <button class="btn btn-primary" onclick="showAddNodeModal()">
                  <i class="fas fa-plus"></i> Ajouter une machine
                </button>
              </div>
              <table
                class="table"
                style="width: 100%; margin-top: 15px; color: var(--text-color)"
              >
                <thead>
                  <tr>
                    <th>Hostname</th>
                    <th>Rôle</th>
                    <th>Statut</th>
                    <th>CPU/RAM (Estimé)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for node in status.nodes %}
                  <tr>
                    <td>
                      <i class="fas fa-microchip"></i> {{ node.hostname }}
                    </td>
                    <td>{{ node.role }}</td>
                    <td>
                      {% if node.status == 'Ready' %}
                      <span class="status-badge status-active">Prêt</span>
                      {% else %}
                      <span class="status-badge status-inactive"
                        >{{ node.status }}</span
                      >
                      {% endif %}
                    </td>
                    <td>
                      <!-- Mock visualization for now -->
                      <div
                        style="
                          background: #444;
                          height: 6px;
                          width: 100px;
                          border-radius: 3px;
                          overflow: hidden;
                        "
                      >
                        <div
                          style="background: #2ecc71; height: 100%; width: 40%"
                        ></div>
                      </div>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="4">
                      Aucun noeud détecté. Activez le mode Swarm.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <h2>État du Cluster</h2>
              <p>
                Status: {% if status.active %}
                <span class="status-badge status-active">Actif</span>
                {% else %}
                <span class="status-badge status-inactive">Inactif</span>
                {% endif %}
              </p>
              <h3>Noeuds</h3>
              <ul>
                {% for node in status.nodes %}
                <li>
                  {{ node.hostname }} - {{ node.role }} ({{ node.status }})
                </li>
                {% else %}
                <li>Aucun noeud détecté (ou docker non swarm)</li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <h2>Configuration</h2>
              <form id="swarmConfigForm">
                <div class="form-group">
                  <label>Mode</label>
                  <select name="mode" id="modeSelect" class="form-control">
                    <option
                      value="local"
                      {%
                      if
                      config.mode=""
                      ="local"
                      %}selected{%
                      endif
                      %}
                    >
                      Local
                    </option>
                    <option
                      value="remote"
                      {%
                      if
                      config.mode=""
                      ="remote"
                      %}selected{%
                      endif
                      %}
                    >
                      endif %} > endif %} > Remote (SSH)
                    </option>
                  </select>
                </div>

                <style>
                  .hidden {
                    display: none !important;
                  }
                </style>
                <div
                  id="remoteConfig"
                  class="{% if config.mode != 'remote' %}hidden{% endif %}"
                >
                  <div class="form-group">
                    <label>Host SSH</label>
                    <input
                      type="text"
                      name="ssh_host"
                      value="{{ config.ssh_host }}"
                      class="form-control"
                    />
                  </div>
                  <div class="form-group">
                    <label>User SSH</label>
                    <input
                      type="text"
                      name="ssh_user"
                      value="{{ config.ssh_user }}"
                      class="form-control"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label>Chemin si-swarm-deploy</label>
                  <input
                    type="text"
                    name="si_swarm_path"
                    value="{{ config.si_swarm_path }}"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label>NFS Server IP (Optionnel)</label>
                  <input
                    type="text"
                    name="nfs_server_ip"
                    value="{{ config.nfs_server_ip }}"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label>NFS Path (Optionnel)</label>
                  <input
                    type="text"
                    name="nfs_path"
                    value="{{ config.nfs_path }}"
                    class="form-control"
                  />
                </div>

                <button
                  type="button"
                  onclick="saveConfig()"
                  class="btn btn-primary"
                >
                  Sauvegarder
                </button>
              </form>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Actions</h2>
          <button class="btn btn-success" onclick="deployInfra()">
            Déployer Infrastructure (si-swarm-deploy)
          </button>
          <div id="deployOutput" style="margin-top: 10px">
            <pre>En attente...</pre>
          </div>
        </div>

        <!-- Modal Ajout Noeud -->
        <div
          id="addNodeModal"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
          "
        >
          <div class="card" style="width: 600px; max-width: 90%">
            <h3 style="margin-top: 0">Ajouter une machine au cluster</h3>
            <p>
              Exécutez cette commande sur la nouvelle machine (Linux/Windows
              avec Docker) :
            </p>
            <div
              style="
                background: #111;
                padding: 10px;
                border-radius: 4px;
                margin: 10px 0;
              "
            >
              <code
                id="joinCommand"
                style="
                  user-select: all;
                  cursor: pointer;
                  color: #2ecc71;
                  background: transparent;
                "
                onclick="copyCommand()"
                >Chargement...</code
              >
            </div>
            <p>
              <small class="text-muted"
                >Assurez-vous que la machine peut joindre le manager sur le port
                2377.</small
              >
            </p>
            <div style="text-align: right">
              <button
                class="btn btn-secondary"
                onclick="
                  document.getElementById('addNodeModal').style.display = 'none'
                "
              >
                Fermer
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      async function showAddNodeModal() {
        document.getElementById("addNodeModal").style.display = "flex";
        const cmdEl = document.getElementById("joinCommand");
        cmdEl.innerText = "Génération du token...";

        try {
          const res = await fetch("/swarm/nodes/token");
          const json = await res.json();
          if (json.status === "success") {
            cmdEl.innerText = json.command;
          } else {
            cmdEl.innerText = "Erreur: " + json.message;
          }
        } catch (e) {
          cmdEl.innerText = "Erreur de connexion API";
        }
      }

      function copyCommand() {
        const el = document.getElementById("joinCommand");
        navigator.clipboard.writeText(el.innerText);
        alert("Commande copiée !");
      }

      document
        .getElementById("modeSelect")
        .addEventListener("change", function (e) {
          document.getElementById("remoteConfig").style.display =
            e.target.value === "remote" ? "block" : "none";
        });

      async function saveConfig() {
        const formData = new FormData(
          document.getElementById("swarmConfigForm"),
        );
        const data = Object.fromEntries(formData.entries());

        const res = await fetch("/swarm/save_config", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')
              .content,
          },
          body: JSON.stringify(data),
        });
        const json = await res.json();
        alert(json.message);
        location.reload();
      }

      async function deployInfra() {
        if (
          !confirm(
            "Voulez-vous vraiment lancer le déploiement de l'infrastructure ? Cela peut prendre du temps.",
          )
        )
          return;

        document.querySelector("#deployOutput pre").innerText =
          "Déploiement en cours...";

        const res = await fetch("/swarm/deploy", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')
              .content,
          },
          body: JSON.stringify({}),
        });
        const json = await res.json();
        document.querySelector("#deployOutput pre").innerText = json.message;
      }
    </script>
  </body>
</html>
